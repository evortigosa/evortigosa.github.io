<!DOCTYPE html>

<!--
	Evandro Scudeleti Ortigossa

	M.Sc. Student in Computer Science
	Institute of Mathematical and Computer Sciences - ICMC
	University of São Paulo - USP
	São Carlos, São Paulo, Brazil.
	
	2016. All rights reserved.
-->

<html>
<head>
	<meta charset="utf-8">
	<title>Pollution Data Visualization</title>

	<link href="nv.d3.css" rel="stylesheet" type="text/css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.2/d3.min.js" charset="utf-8"></script>
	<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
	<script src="nv.d3.js"></script>

	<style>

		body {
			font-family: sans-serif;
			font-color: black;
		}

		.axis path, .axis line {
			fill: none;
			stroke: #000;
			shape-rendering: crispEdges;
		}

		.dot {
			stroke: #000;
		}

		.grid .tick {
			stroke: lightgrey;
			opacity: 0.5;
			shape-rendering: crispEdges;
		}

		.grid path {
			stroke-width: 0.5px;
		}

		/* Tooltip */
		div.tooltip {
			width: 110px;
			padding: 10px;
			font: 10px sans-serif;
			font-weight: bold;
			text-align: center;
			color: #fff;
			position: absolute;
			background: rgba(0,0,0,0.7);
			border: 0px;
			border-radius: 8px;
			pointer-events: none;
		}

  	</style>

</head>
<body>

	<div style="width:100%;height:100%">
		<div id="data_in" class="Combo" style="width:100%;height:20px">
			<select type="select" onchange="updateData(value);">
				<option value="14_15" selected="true">Feb 2014 to May 2015</option>
				<option value="97_06">Sep 1997 to Feb 2006</option>
				<option value="97_15">Sep 1997 to May 2015</option>
			</select>
		</div>
		<div style="margin:auto;width:1600px;height:860px">
			<div id="view1" class="Graph" style="width:100%;height:850px"></div>
		</div>
	</div>

	<script>

		var parseDate= d3.time.format("%m/%d/%Y").parse;
		var d_source= "data.tsv";
		var flag= 0;

		// Update data from combobox onChange
		function updateData(value) {

			if (value=== "14_15") {
				d_source= "data.tsv";
				flag= 0;
			}
			else if (value=== "97_06") {
				d_source= "data97_06.tsv";
				flag= 1;
			}
			else {
				d_source= "data97_15.tsv";
				flag= 2;
			}

			init();
		};

		function init() {

			d3.tsv(d_source, function(error, data) {
				if (error) throw error;

				data.forEach(function(d) {
					d.date= parseDate(d.date);
					d.concentracao= +d.concentracao;
				});

				drawPlot(data);
			});
		};

		init();


		function color_group(index_color) {
			var color_range= ["#1b9e77","#d95f02","#7570b3","#66a61e","#e7298a","#e6ab02","#a6761d","#666666","#377eb8","#ff7f00"];
			
			return color_range[index_color];
		};

		function drawPlot(data) {

			var margin= {top: 20, right: 35, bottom: 30, left: 60};

			var size= document.getElementById("view1").clientWidth;

			var width= size- margin.left- margin.right;
			var height= 800- margin.top- margin.bottom;

			var x_scale= d3.time.scale()
				.range([0, width])		// Escala horizontal - range
				.domain(d3.extent(data, function(d) { return d.date; }));

			var y_scale= d3.scale.linear()
				.range([height, 0])
				.domain(d3.extent(data, function(d) { return d.concentracao; })).nice();

			var color= d3.scale.category10();

			document.getElementById("view1").innerHTML= "";

			var canvas= d3.select("#view1")
				.append("svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom)
				.append("g")
					.attr("transform", "translate(" + margin.left + "," + margin.top + ")");


			function make_x_axis() {		// function for the x grid lines
				return d3.svg.axis()
					.scale(x_scale)
					.orient("bottom")
			};

			canvas.append("g")				// Draw the x Grid lines
				.attr("class", "grid")
				.attr("transform", "translate(0," + height + ")")
				.call(make_x_axis()
				.tickSize(-height, 0, 0)
				.tickFormat(""));

			function make_y_axis() {		// function for the y grid lines
				return d3.svg.axis()
						.scale(y_scale)
						.orient("left");
			};

			canvas.append("g")				// Draw the y Grid lines
				.attr("class", "grid")
				.call(make_y_axis()
					.tickSize(-width, 0, 0)
					.tickFormat(""));


			var tip= d3.select("#view1")
				.append("div")
				.attr("class", "tooltip")
				.style("opacity", 0);


			canvas.selectAll(".dot")
				.data(data)
				.enter().append("circle")
					.attr("class", "dot")
					.attr("r", 4)
					.attr("cx", function(d) { return x_scale(d.date); })
					.attr("cy", function(d) { return y_scale(d.concentracao); })
					.style("fill", function(d) { return color_group(1); })
					.on("mouseover", function(d) {
						tip.transition()
							.duration(200)
							.style("opacity", 1);

						tip.html("Concentração:  " + d.concentracao + " (μg/m³)" + "<br>Data da amostragem: " + d3.time.format("%d-%b-%Y")(d.date))
							.style("left", (d3.event.pageX- 60) + "px")
							.style("top", (d3.event.pageY+ 10) + "px");
					})
					.on("mouseout", function(d) {
						tip.transition()
							.duration(500)
							.style("opacity", 0);
					});


			var xAxis;

			if (flag== 0) {
				xAxis= d3.svg.axis()
					.scale(x_scale)
					.ticks(d3.time.months)
					.orient("bottom")
					.tickFormat(d3.time.format("%b-%Y"));
			}
			else {
				xAxis= d3.svg.axis()
					.scale(x_scale)
					.ticks(d3.time.years)
					.orient("bottom")
					.tickFormat(d3.time.format("%Y"));	
			}

			var yAxis= d3.svg.axis()
				.scale(y_scale)
				.orient("left");

			/* Construcao dos eixos */
			canvas.append("g")
				.attr("class", "x axis")
				.attr("transform", "translate(0," + height + ")")
				.call(xAxis)
				.append("text")
					.attr("class", "label")
					.attr("x", width/ 2)
					.attr("y", 60)
					.style("text-anchor", "middle")
					.text("Período da Amostragem");

			canvas.append("g")
				.attr("class", "y axis")
				.call(yAxis)
				.append("text")
					.attr("class", "label")
					.attr("transform", "rotate(-90)")
					.attr("x", -(height/ 2))
					.attr("y", -60)
					.attr("dy", ".71em")
					.style("text-anchor", "middle")
					.text("Concentração (μg/m³)")
		};

	</script>

</body>
</html>
