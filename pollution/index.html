<!DOCTYPE html>

<!--
	Evandro Scudeleti Ortigossa

	M.Sc. Student in Computer Science
	Institute of Mathematical and Computer Sciences - ICMC
	University of São Paulo - USP
	São Carlos, São Paulo, Brazil.
	
	2016. All rights reserved.
-->

<html>
<head>
	<meta charset="utf-8">
	<title>Pollution Data Visualization</title>

	<link href="nv.d3.css" rel="stylesheet" type="text/css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.2/d3.min.js" charset="utf-8"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
	<script src="nv.d3.js"></script>

	<style>

		body {
			font-family: sans-serif;
			font-color: black;
		}

		.axis path, .axis line {
			fill: none;
			stroke: #000;
			shape-rendering: crispEdges;
		}

		.dot {
			stroke: #000;
		}

		.dot:hover {
			stroke-width: 3px;
		}

		.grid .tick {
			stroke: lightgrey;
			opacity: 0.5;
			shape-rendering: crispEdges;
		}

		.grid path {
			stroke-width: 0.5px;
		}

		/* Tooltip */
		div.tooltip {
			width: 110px;
			padding: 10px;
			font: 10px sans-serif;
			font-weight: bold;
			text-align: center;
			color: #fff;
			position: absolute;
			background: rgba(0,0,0,0.7);
			border: 0px;
			border-radius: 8px;
			pointer-events: none;
		}

  	</style>

</head>
<body>

	<div style="width:100%;height:100%">
		<div style="margin:auto;width:1800px;height:450px">
			<div id="view1" class="Graph" style="width:100%;height:450px"></div>
		</div>
		<div style="margin:auto;width:1800px;height:55px">
			<div id="view_var" class="Graph" style="width:100%;height:55px"></div>
		</div>
		<div style="margin:auto;width:1800px;height:450px">
			<div id="view2" class="Graph" style="width:100%;height:450px"></div>
		</div>
		<div style="width:1800px;height:20px">
			<div id="combo" class="Graph" style="float:left;width:20%;height:20px">
				<select type="select" onchange="updateData(value);">
					<option value="97_06" selected="true">Sep 1997 to Feb 2006</option>
					<option value="98_99">1998 to 1999</option>
					<option value="99_00">1999 to 2000</option>
					<option value="00_01">2000 to 2001</option>
					<option value="01_02">2001 to 2002</option>
					<option value="02_03">2002 to 2003</option>
					<option value="03_04">2003 to 2004</option>
					<option value="04_05">2004 to 2005</option>
					<option value="05_06">2005 to 2006</option>
					<option value="97_15">Sep 1997 to May 2015</option>
				</select>
			</div>
			<div id="legenda" class="Graph" style="float:left;width:80%;height:20px"></div>
		</div>
	</div>

	<script>

		var parseDate= d3.time.format("%m/%d/%Y").parse;
		
		var path= "/pollution/data/";
		var v1_source= path + "data.tsv";
		
		var time_hor= 1;


		var r_scale;
		var aux_r_scale= path + "data97_15.tsv";

		d3.tsv(aux_r_scale, function(error, data) {	
			if (error) throw error;

			data.forEach(function(d) {
				d.date= parseDate(d.date);
				d.concentracao= +d.concentracao;
			});

			r_scale= d3.scale.linear()	/* Dentre todas as concentracoes, encontra os extremos para escalar os circulos corretamente */
				.range([3, 15])
				.domain(d3.extent(data, function(d) { return d.concentracao; }));
		});


		// Update data from combobox onChange
		function updateData(value) {
			var v2_source= "";
			
			time_hor= 1;

			if (value=== "97_06") {
				v2_source= "data97_06.tsv";
				time_hor= 2;
			}
			else if (value=== "98_99") {
				v2_source= "98_99.tsv";
			}
			else if (value=== "99_00") {
				v2_source= "99_00.tsv";
			}
			else if (value=== "00_01") {
				v2_source= "00_01.tsv";
			}
			else if (value=== "01_02") {
				v2_source= "01_02.tsv";
			}
			else if (value=== "02_03") {
				v2_source= "02_03.tsv";
			}
			else if (value=== "03_04") {
				v2_source= "03_04.tsv";
			}
			else if (value=== "04_05") {
				v2_source= "04_05.tsv";
			}
			else if (value=== "05_06") {
				v2_source= "05_06.tsv";
			}
			else if (value=== "97_15") {
				v2_source= "data97_15.tsv";
				time_hor= 2;
			}

			var path_vari= path + "differences/" + v2_source;
			v2_source= path + v2_source;

			init(v2_source, "view2");
			
			if (time_hor== 1) initDifference(path_vari, "view_var");
			else document.getElementById("view_var").innerHTML= "";
		};

		function init(init_source, view) {

			d3.tsv(init_source, function(error, data) {
				if (error) throw error;

				data.forEach(function(d) {
					d.date= parseDate(d.date);
					d.concentracao= +d.concentracao;
				});

				drawPlot(data, view);
			});
		};
		
		function initVariation(init_source, view) {

			d3.tsv(init_source, function(error, data) {
				if (error) throw error;

				var elements= data.map(function(d) {
					return { date: parseDate(d.date), value: Math.abs((+d.concentracaoA)- (+d.concentracaoB)) };
				});

				drawLine(elements, view);
			});
		};

		function addLegend() {
			var size= document.getElementById("legenda").clientWidth;

			var h_shift= size- 520;
			var vertical_pad= 10;
			var pos_box= 80;
			var pos_text= 20;

			var texto= ["Chuvoso","Outono","Seco","Primavera"];
			var cor_leg= [3,1,0,2];

			var canvas= d3.select("#legenda")
					.append("svg")
					.attr("width", size)
					.attr("height", 30)
					.append("g")
						.attr("transform", "translate(0,0)");

			var top_label= canvas.append("text")
				.attr("x", h_shift- 20)
				.attr("y", vertical_pad+ 3)
				.attr("font-family", "sans-serif")
				.attr("font-size", "14px")
				.attr("font-weight", "bold")
				.attr("fill", "black")
				.text("Período:");


			for ((i= 0); (i< 4); (i++)) {

				canvas.append("rect")
					.attr("x", ((i+ 1)*pos_box+ i*pos_text+ h_shift))
					.attr("y", vertical_pad- 10)
					.attr("width", 16)
					.attr("height", 16)
					.attr("fill", color_group(cor_leg[i]));

				canvas.append("text")
					.attr("x", ((i+ 1)*pos_box+ (i+ 1)*pos_text+ h_shift))
					.attr("y", vertical_pad+ 3)
					.attr("font-family", "sans-serif")
					.attr("font-size", "14px")
					.attr("font-weight", "bold")
					.attr("fill", "black")
					.text(texto[i]);
			}
		};


		init(d_source, "view1");
		updateData("97_06");
		addLegend();


		function color_group(index_color) {
			var color_range= ["#e66101","#fdb863","#b2abd2","#5e3c99"];
			
			return color_range[index_color];
		};

		function drawPlot(data, view) {	// view assume os valores (string), view1 ou view2

			var margin= {top: 20, right: 70, bottom: 30, left: 60};

			var size= document.getElementById(view).clientWidth;

			var width= size- margin.left- margin.right;
			var height= 420- margin.top- margin.bottom;

			var x_scale= d3.time.scale()
				.range([0, width])		// Escala horizontal - range
				.domain(d3.extent(data, function(d) { return d.date; })).nice();

			var y_scale= d3.scale.linear()
				.range([height, 0])
				.domain(d3.extent(data, function(d) { return d.concentracao; })).nice();


			document.getElementById(view).innerHTML= "";

			var view_aux= "#" + view;

			var canvas= d3.select(view_aux)
				.append("svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom)
				.append("g")
					.attr("transform", "translate(" + margin.left + "," + margin.top + ")");


			function make_x_axis() {		// function for the x grid lines
				return d3.svg.axis()
					.scale(x_scale)
					.orient("bottom")
			};

			canvas.append("g")				// Draw the x Grid lines
				.attr("class", "grid")
				.attr("transform", "translate(0," + height + ")")
				.call(make_x_axis()
				.tickSize(-height, 0, 0)
				.tickFormat(""));

			function make_y_axis() {		// function for the y grid lines
				return d3.svg.axis()
						.scale(y_scale)
						.orient("left");
			};

			canvas.append("g")				// Draw the y Grid lines
				.attr("class", "grid")
				.call(make_y_axis()
					.tickSize(-width, 0, 0)
					.tickFormat(""));


			var tip= d3.select(view_aux)
				.append("div")
				.attr("class", "tooltip")
				.style("opacity", 0);


			canvas.selectAll(".dot")
				.data(data)
				.enter().append("circle")
					.attr("class", "dot")
					.attr("r", function(d) { return r_scale(0); })
					.attr("cx", function(d) { return x_scale(d.date); })
					.attr("cy", function(d) { return height; })
					.style("fill", function(d) { 
						var date_aux= new Date(d.date);
						var n_month= date_aux.getMonth();	// returns 0 - 11

						if ((n_month>= 2) && (n_month<= 4)) return color_group(1);	// outono
						else if ((n_month>= 5) && (n_month<= 8)) return color_group(0);	// seco
						else if (n_month== 9) return color_group(2);	// primavera
						return color_group(3);	// chuvoso
					})
					.style("opacity", 0.9)
					.on("mouseover", function(d) {
						tip.transition()
							.duration(200)
							.style("opacity", 1);
					})
					.on("mousemove", function(d) {
						tip.html("Concentração:  " + d.concentracao + " (μg/m³)" + "<br>Data da amostragem: " + d3.time.format("%d-%b-%Y")(d.date))
							.style("left", (d3.event.pageX- 60) + "px")
							.style("top", (d3.event.pageY+ 20) + "px");
					})
					.on("mouseout", function(d) {
						tip.transition()
							.duration(500)
							.style("opacity", 0);
					})
					.transition()
						.duration(1000)
						.attr("cy", function(d) { return y_scale(d.concentracao); })
						.attr("r", function(d) { if (d.concentracao> 0.001) return r_scale(d.concentracao); });


			var xAxis;

			if ((view=== "view1") || (time_hor== 1)) {
				xAxis= d3.svg.axis()
					.scale(x_scale)
					.ticks(d3.time.months)
					.orient("bottom")
					.tickFormat(d3.time.format("%b-%Y"));
			}
			else if (time_hor== 2) {
				xAxis= d3.svg.axis()
					.scale(x_scale)
					.ticks(d3.time.years)
					.orient("bottom")
					.tickFormat(d3.time.format("%Y"));	
			}

			var yAxis= d3.svg.axis()
				.scale(y_scale)
				.orient("left");

			/* Construcao dos eixos */
			canvas.append("g")
				.attr("class", "x axis")
				.attr("transform", "translate(0," + height + ")")
				.call(xAxis)
				.append("text")
					.attr("class", "label")
					.attr("x", width/ 2)
					.attr("y", 57)
					.style("text-anchor", "middle")
					.text("Período da Amostragem");

			canvas.append("g")
				.attr("class", "y axis")
				.call(yAxis)
				.append("text")
					.attr("class", "label")
					.attr("transform", "rotate(-90)")
					.attr("x", -(height/ 2))
					.attr("y", -58)
					.attr("dy", ".71em")
					.style("text-anchor", "middle")
					.text("Concentração (μg/m³)")
		};
		
		function drawLine(data, view) {	// view assume os valores (string), view1 ou view2

			var margin= {top: 4, right: 70, bottom: 1, left: 60};

			var size= document.getElementById(view).clientWidth;

			var width= size- margin.left- margin.right;
			var height= 50- margin.top- margin.bottom;

			var time= 1000;
			var formatValue= d3.format(",.2f");
			var formatMass= function(d) { return formatValue(d) + " μg/m³"; };

			var x_scale= d3.time.scale()
				.range([0, width])		// Escala horizontal - range
				.domain(d3.extent(data, function(d) { return d.date; })).nice();

			var y_scale= d3.scale.linear()
				.range([height, 0])
				.domain([0, d3.max(data, function(d) { return d.value; })]).nice();


			document.getElementById(view).innerHTML= "";

			var view_aux= "#" + view;

			var canvas= d3.select(view_aux)
				.append("svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom)
				.append("g")
					.attr("transform", "translate(" + margin.left + "," + margin.top + ")");


			var line= d3.svg.line()
				.interpolate("linear")
				.x(function(d) { return x_scale(d.date); })
				.y(function(d) { return y_scale(d.value); });

			var path= canvas.append("path")
				.datum(data)
					.attr("class", "line")		// Desenha o caminho, como funcao da linha
					.attr("d", line)
					.attr("fill", "none")
					.attr("stroke", color_group(4))
					.attr("stroke-width", "3px")
					.attr("stroke-dasharray", function() { return "0," + this.getTotalLength(); })
					.transition()
						.duration(time)
						.ease("linear")
						.attrTween("stroke-dasharray", animateLine);

			function animateLine() {
				var length= this.getTotalLength();
				i= d3.interpolateString("0," + length, length + "," +length);

				return function(t) { return i(t); };
			};


			var vertical_line= canvas.append("g")		// Append line in the Line Chart
				.attr("class", "marker_line")
				.style("display", "none");

			vertical_line.append("line")
				.attr("y1", -15)
				.attr("y2", height)
				.attr("fill", "none")
				.style("stroke-width", "1px")
				.style("stroke", "steelblue")
				.style("stroke-dasharray", "4,4");

			var marker= canvas.append("g")		// Append marker in the Line Chart
				.attr("class", "marker")
				.style("display", "none");

			marker.append("circle")
				.attr("r", 4)
				.style("fill", color_group(4))
				.style("pointer-events", "none")
				.style("stroke", "black")
				.style("stroke-width", "2px");

			marker.append("text")
				.attr("x", 10)
				.attr("dy", ".4em")
				.attr("font-family", "sans-serif")
				.attr("font-size", "12px");


			canvas.append("rect")		// Plano de eventos
				.attr("width", width)
				.attr("height", height)
				.style("fill", "none")
				.on("mouseover", function() {
					vertical_line.style("display", null);
					marker.style("display", null); 
				})
				.on("mouseout", function() { 
					vertical_line.style("display", "none");
					marker.style("display", "none"); 
				})
				.on("mousemove", mouseMove)
				.transition()
					.delay(time)
					.style("pointer-events", "all");


			var bisectDate= d3.bisector(function(d) { return d.date; }).left;	// Create custom bisector

			function mouseMove() {		// Add event listeners/handlers

				var x0= x_scale.invert(d3.mouse(this)[0]),
					index= bisectDate(data, x0, 1),
					start= data[index- 1],
					end= data[index],
					d= x0 - start.date > end.date - x0 ? end : start;
				
				vertical_line.attr("transform", "translate(" + x_scale(d.date) + ",0)");

				marker.attr("transform", "translate(" + x_scale(d.date) + "," + y_scale(d.value) + ")");
				
				if (d.value== 0) {
					marker.select("text")
						.attr("y", -13)
						.text(formatMass(d.value));
				}
				else {
					marker.select("text")
						.attr("y", 0)
						.text(formatMass(d.value));
				}
			};


			var xAxis= d3.svg.axis()
				.scale(x_scale)
				.ticks(d3.time.months)
				.orient("bottom")
				.tickFormat("");

			var yAxis= d3.svg.axis()
				.scale(y_scale)
				.ticks(0)
				.orient("left");

			/* Construcao dos eixos */
			canvas.append("g")
				.attr("class", "x axis")
				.attr("transform", "translate(0," + height + ")")
				.call(xAxis);

			canvas.append("g")
				.attr("class", "y axis")
				.call(yAxis)
				.append("text")
					.attr("class", "label")
					.attr("transform", "rotate(-90)")
					.attr("x", -(height/ 2))
					.attr("y", -58)
					.attr("dy", ".71em")
					.style("text-anchor", "middle")
					.attr("font-size", "14px")
					.text("Variação");
		};

	</script>

</body>
</html>
