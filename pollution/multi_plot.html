<!DOCTYPE html>

<!--
	Evandro Scudeleti Ortigossa

	M.Sc. Student in Computer Science
	Institute of Mathematical and Computer Sciences - ICMC
	University of São Paulo - USP
	São Carlos, São Paulo, Brazil.
	
	2016. All rights reserved.
-->

<html>
<head>
	<meta charset="utf-8">
	<title>Pollution Data Visualization - Variables</title>

	<link href="nv.d3.css" rel="stylesheet" type="text/css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.2/d3.min.js" charset="utf-8"></script>
	<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
	<script src="nv.d3.js"></script>

	<style>

		body {
			font-family: sans-serif;
			font-color: black;
			font-size: 12px;
		}

		.axis {
			shape-rendering: crispEdges;
		}

		.axis line {
			stroke: #ddd;
			stroke-width: .5px;
		}

		.axis path {
			display: none;
		}

		rect.extent {
			fill: #000;
			fill-opacity: .25;
			stroke: #fff;
		}

		rect.frame {
			fill: #fff;
			fill-opacity: .75;
			stroke: #aaa;
		}

		circle {
			fill: #ccc;
			fill-opacity: .75;
		}

		.legend circle {
			fill-opacity: 1;
		}

		.legend text {
			font-size: 18px;
			font-style: oblique;
		}

		.cell text {
			pointer-events: none;
		}

		.setosa {
			fill: #1b9e77;
		}

		.versicolor {
			fill: #d95f02;
		}

		.virginica {
			fill: #7570b3;
		}

  	</style>

</head>
<body>

	<div style="width:100%;height:100%">
		<div id="data_in" class="Combo" style="width:100%;height:20px">
			<select type="select" onchange="updateData(value);">
				<option value="14_15" selected="true">Feb 2014 to May 2015</option>
				<option value="97_06">Sep 1997 to Feb 2006</option>
				<option value="97_15">Sep 1997 to May 2015</option>
			</select>
		</div>
		<div style="margin:auto;width:1600px;height:860px">
			<div id="view1" class="Graph" style="width:100%;height:850px"></div>
		</div>
	</div>

	<script>

		var parseDate= d3.time.format("%m/%d/%Y").parse;
		var d_source= "data.tsv";
		var flag= 0;

		// Size parameters.
		var size= 200;
		var padding= 20;
		var n= 4;
		var traits= ["sepal length", "sepal width", "petal length", "petal width"];

		// Position scales.
		var x= {}, y= {};

		// Update data from combobox onChange
		function updateData(value) {

			if (value=== "14_15") {
				d_source= "data.tsv";
				flag= 0;
			}
			else if (value=== "97_06") {
				d_source= "data97_06.tsv";
				flag= 1;
			}
			else {
				d_source= "data97_15.tsv";
				flag= 2;
			}

			init();
		};

		function init() {

			d3.csv("iris.csv", function(data) {

				traits.forEach(function(trait) {
					// Coerce values to numbers.
					data.forEach(function(d) { d[trait] = +d[trait]; });

					var value= function(d) { return d[trait]; };
					var domain= [d3.min(data, value), d3.max(data, value)];
					var range= [padding / 2, size - padding / 2];
					
					x[trait]= d3.scale.linear().domain(domain).range(range);
					y[trait]= d3.scale.linear().domain(domain).range(range.reverse());
				});

				drawPlot(data);
			});
		};

		init();


		function color_group(index_color) {
			var color_range= ["#1b9e77","#d95f02","#7570b3","#66a61e","#e7298a","#e6ab02","#a6761d","#666666","#377eb8","#ff7f00"];
			
			return color_range[index_color];
		};

		function drawPlot(data) {

			var margin= {top: 20, right: 20, bottom: 20, left: 200};

			var width= 1200- margin.left- margin.right;
			var height= 800- margin.top- margin.bottom;

			// Root panel.
			var canvas= d3.select("#view1")
				.append("svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom)
				.append("g")
					.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

			// Legend.
			var legend= canvas.selectAll(".legend")
				.data(["setosa", "versicolor", "virginica"])
				.enter().append("g")
					.attr("class", "legend")
					.attr("transform", function(d, i) { return "translate(-180," + (i * 20 + 594) + ")"; });

			legend.append("circle")
				.attr("class", String)
				.attr("r", 3);

			legend.append("text")
				.attr("x", 12)
				.attr("dy", ".31em")
				.text(function(d) { return "Iris " + d; });


			// Brush.
			var brush= d3.svg.brush()
				.on("brushstart", brushstart)
				.on("brush", brush)
				.on("brushend", brushend);


			// Axes.
			var axis= d3.svg.axis()
				.ticks(5)
				.tickSize(size * n);

			// X-axis.
			canvas.selectAll(".x.axis")
				.data(traits)
				.enter().append("g")
					.attr("class", "x axis")
					.attr("transform", function(d, i) { return "translate(" + i * size + ",0)"; })
					.each(function(d) { d3.select(this).call(axis.scale(x[d]).orient("bottom")); });

			// Y-axis.
			canvas.selectAll(".y.axis")
				.data(traits)
				.enter().append("g")
					.attr("class", "y axis")
					.attr("transform", function(d, i) { return "translate(0," + i * size + ")"; })
					.each(function(d) { d3.select(this).call(axis.scale(y[d]).orient("right")); });


			// Cell and plot.
			var cell= canvas.selectAll(".cell")
				.data(cross(traits, traits))
				.enter().append("g")
					.attr("class", "cell")
					.attr("transform", function(d) { return "translate(" + d.i * size + "," + d.j * size + ")"; })
					.each(plot);

			// Titles for the diagonal.
			cell.filter(function(d) { return d.i == d.j; }).append("text")
				.attr("x", padding)
				.attr("y", padding)
				.attr("dy", ".71em")
				.text(function(d) { return d.x; });

			function plot(p) {
				var cell= d3.select(this);

				// Plot frame.
				cell.append("rect")
					.attr("class", "frame")
					.attr("x", padding / 2)
					.attr("y", padding / 2)
					.attr("width", size - padding)
					.attr("height", size - padding);

				// Plot dots.
				cell.selectAll("circle")
					.data(data)
					.enter().append("circle")
					.attr("class", function(d) { return d.species; })
					.attr("cx", function(d) { return x[p.x](d[p.x]); })
					.attr("cy", function(d) { return y[p.y](d[p.y]); })
					.attr("r", 3);

				// Plot brush.
				cell.call(brush.x(x[p.x]).y(y[p.y]));
			};

			// Clear the previously-active brush, if any.
			function brushstart(p) {
				if (brush.data !== p) {
					cell.call(brush.clear());
					brush.x(x[p.x]).y(y[p.y]).data = p;
				}
			};

			// Highlight the selected circles.
			function brush(p) {
				var e= brush.extent();
				
				canvas.selectAll(".cell circle").attr("class", function(d) {
					return e[0][0] <= d[p.x] && d[p.x] <= e[1][0]
					&& e[0][1] <= d[p.y] && d[p.y] <= e[1][1]
					? d.species : null;
				});
			};

			// If the brush is empty, select all circles.
			function brushend() {
				if (brush.empty()) canvas.selectAll(".cell circle").attr("class", function(d) {
					return d.species;
				});
			};

			function cross(a, b) {
				var c= [], n= a.length, m= b.length, i, j;

					for (i = -1; ++i < n;) 
						for (j = -1; ++j < m;) c.push({x: a[i], i: i, y: b[j], j: j});
					return c;
			};

		};

	</script>

</body>
</html>
