</!DOCTYPE html>

<!--
	Evandro Scudeleti Ortigossa

	M.Sc. Student in Computer Science
	Institute of Mathematical and Computer Sciences - ICMC
	University of São Paulo - USP
	São Carlos, São Paulo, Brazil.
	
	2018. All rights reserved.
-->

<html>
<head>
	<meta charset="utf-8">
	<title>Difference Chart - Pollution Data Visualization</title>

	<script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>

	<style type="text/css">

		body {
			font: 12px sans-serif;
			font-color: black;
		}
		
		.axis path, .axis line {
			fill: none;
			stroke: #000;
			stroke-width: 2px;
			shape-rendering: crispEdges;
		}

		.x.axis path {
			display: none;
		}

		.area.above {
			fill: #e41a1c;
			opacity: 0.75;
		}

		.area.below {
			fill: #377eb8;
			opacity: 0.75;
		}

		.area.above:hover {
			opacity: 0.95;
		}

		.area.below:hover {
			opacity: 0.95;
		}

		.line {
			fill: none;
			stroke: #000;
			stroke-width: 1.5px;
		}

	</style>

</head>
<body>

	<div id="view_dif" class="Graph" style="width:100%;height:100%"></div>

	<script type="text/javascript">


		var view= "view_dif"


		var parseDate= d3.timeParse("%Y-%m-%d");


		d3.csv("/pollution/data/downloads.csv", function(error, data) {

			data.forEach(function(d) {
				d.dtg= parseDate(d.date_entered);
				d.downloaded= +d.downloaded;
			});

			var data= d3.nest()
				.key(function(d) { return d.dtg; })
				.entries(data);

			data.forEach(function(d) {
				d.dtg= d.values[0]['dtg'];
				d["Science"]= d.values[0]['downloaded'];
				d["Style"]= d.values[1]['downloaded'];
			});

			for (i= data.length- 1; i> 0; i--) {
				data[i].Science= data[i].Science- data[(i- 1)].Science ;
				data[i].Style= data[i].Style- data[(i- 1)].Style ;
			}

			data.shift(); // Removes the first element in the array

			drawDifference(data, view);

		});

		function drawDifference(data, view) {

			var margin= {top: 20, right: 30, bottom: 45, left: 60};

			var size= document.getElementById(view).clientWidth;

			var width= size- margin.left- margin.right;
			var height= 450- margin.top- margin.bottom;
			

			var x_scale= d3.scaleTime()		// Escala horizontal
				.range([0, width]);

			var y_scale= d3.scaleLinear()	// Escala vertical
				.range([height, 0]);

			x_scale.domain(d3.extent(data, function(d) { return d.dtg; }));
			y_scale.domain([
			//	0,
				d3.min(data, function(d) { return Math.min(d["Science"], d["Style"]); }),
			//	d3.max(data, function(d) { return Math.max(d["Science"], d["Style"]); })
				1400
			]).nice();


			var lineA= d3.area()
				.curve(d3.curveBundle.beta(1))
				.x(function(d) { return x_scale(d.dtg); })
				.y(function(d) { return y_scale(d["Science"]); });

			var lineB= d3.area()
				.curve(d3.curveBundle.beta(1))
				.x(function(d) { return x_scale(d.dtg); })
				.y(function(d) { return y_scale(d["Style"]); });

			var area= d3.area()
				.curve(d3.curveBundle.beta(1))
				.x(function(d) { return x_scale(d.dtg); })
				.y1(function(d) { return y_scale(d["Science"]); });


			document.getElementById(view).innerHTML= "";

			var view_aux= "#" + view;

			var canvas= d3.select(view_aux)
				.append("svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom)
				.append("g")
					.attr("transform", "translate(" + margin.left + "," + margin.top + ")");


			canvas.datum(data);

			canvas.append("clipPath")
				.attr("id", "clip-above")
				.append("path")
				.attr("d", area.y0(0));

			canvas.append("clipPath")
				.attr("id", "clip-below")
				.append("path")
				.attr("d", area.y0(height));

			canvas.append("path")
				.attr("class", "area above")
				.attr("clip-path", "url(#clip-above)")
				.attr("d", area.y0(function(d) { return y_scale(d["Style"]); }));

			canvas.append("path")
				.attr("class", "area below")
				.attr("clip-path", "url(#clip-below)")
				.attr("d", area.y0(function(d) { return y_scale(d["Style"]); }));

			canvas.append("path")
				.attr("class", "line")
				.style("stroke", "darkblue")
				.attr("d", lineA);

			canvas.append("path")
				.attr("class", "line")
				.style("stroke", "darkred")
				.attr("d", lineB);


			var xAxis= d3.axisBottom(x_scale)			// Construcao dos eixos
				.tickFormat(d3.timeFormat("%b-%Y"));

			var yAxis= d3.axisLeft(y_scale)
				.tickFormat(d3.format(".1f"));
			
			canvas.append("g")
				.attr("class", "axis-x")
				.attr("transform", "translate(0," + height + ")")
				.call(xAxis);
				
			canvas.append("text")
				.attr("class", "label")
				.attr("x", width/ 2)
				.attr("y", height+ margin.bottom- 4)
				.style("text-anchor", "middle")
				.text("Período da Amostragem");

			canvas.append("g")
				.attr("class", "axis-y")
				.call(yAxis);

		};

	</script>

</body>
</html>